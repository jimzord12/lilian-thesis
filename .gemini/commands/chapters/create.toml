description = "Create a new chapter for the Thesis."

prompt = """
# **Chapter Creation Workflow**

## 0. ENVIRONMENT VALIDATION

**Rule:** You must verify that the current working directory follows the project's file system convention.
1. Check for the existence of `chapter-progress-tracker.md` and `thesis-outline.md` in the current directory.
2. If these files are missing, you **MUST HALT** and ask the user to navigate to the project root or provide the path.
3. You are encouraged to use `list_dir` to verify the environment before proceeding.

## **1. File System Awareness**

You are operating within a strict directory structure. You must parse this structure to locate your source material.

### **File System Convention**

- **Root:**

  - `chapter-progress-tracker.md`: The state file.

  - `thesis-outline.md`: The master plan.

  - **Chapters Folder:** `chapters/`.

    - **Chapter Folders:** `chapters/Chapter-N` (e.g., `Chapter-1`, `Chapter-2`).

      - **Source Material:** Inside `chapters/Chapter-N/sections/`, you will find `Section X.Y.md` files.

      - **Final Chapter Document:** `chapters/Chapter-N/Chapter N_ [Title].md`.

      - **Translated File (if applicable):** `chapters/Chapter-N/primary_lang/Chapter N_ [Title].md`.
      - **Translated Humanized File (if applicable):** `chapters/Chapter-N/primary_lang/Chapter N_ [Title]-Humanized.md`.

- **Destination:** You will create `chapters/Chapter-N/Chapter N_ [Title].md`.

## **2. Operational Workflow**

## **Phase 1: Discovery & Validation**

1. **Read State:** Analyze `chapter-progress-tracker.md` to identify the first **unchecked** Chapter.

2. **Scan Directory:** Look into the corresponding `chapters/Chapter-N/sections/` folder. Identify all available `Section X.Y.md` files.

3. **User Confirmation (CRITICAL PAUSE):**

   - You must output a summary message _before_ generating content.

   - **Format:**

     **Target:** Chapter [N]: [Title]
     **Sections Found:**

     - Section [N.1]: [Title]

     - Section [N.2]: [Title]
       ...
       _Shall I proceed with assembly?_

4. **Wait** for user approval.

## **Phase 2: Content Assembly**

Upon approval, perform the following actions:

1. **Read the Chapter Template:** `"docs/Chapter_Template.md"`

2. **Use the Template Structure** to create the Chapter document.

3. **Ingest:** Read all identified section files.

4. **Synthesize Chapter Overview:**

   - Do _not_ simply copy the first section.

   - Write a **new** 300-word overview that defines the chapter's domain and summarizes the pillars (sections) that follow.

5. **Append Sections:**

   - Insert the content of each `Section X.Y.md` sequentially.

   - **Header Formatting:** Ensure each section title is formatted as `## X.Y: [Title]`, **NOT** `## Section X.Y: [Title]`.

   - **Clean Up:** Remove any individual "References" headers found _inside_ the sections (we will merge them at the end).

6. **Synthesize Chapter Conclusion:**

   - Write a **new** 400-word conclusion.

   - Summarize key findings from all sections.

   - Highlight research gaps identified across the sections.

   - Provide a "Research Contribution" statement linking this chapter to the next.

## **Phase 3: Reference Management (High Priority)**

1. **Extraction:** Extract all references from the bottom of every Section file.

2. **Deduplication:**

   - Compare references by Title, Author, and Year.

   - If a duplicate is found, keep the most complete citation version.

   - Ensure strict APA format consistency.

3. **Compilation:** Append a single **"## References"** section at the very end of the Chapter document containing the merged, alphabetized list.

## **Phase 4: Finalization**

1. **Write File:** Save the complete text to `chapters/Chapter-N/Chapter N_ [Title].md`.

2. **Update Tracker:** Modify `chapter-progress-tracker.md` to mark this Chapter as checked `[x]`.

## **3. Constraints & Quality Control**

- **Tone:** Strict academic tone (impersonal, objective).

- **Formatting:** Use standard Markdown headers (`#` for Chapter Title, `##` for Section Titles).

- **Missing Files:** If a section listed in the `thesis-outline.md` is missing from the `sections/` folder, warn the user during **Phase 1** but offer to proceed with available files.

- **No Hallucinations:** Do not invent content for the Sections. Only invent the _synthesis_ text (Intro/Conclusion) based on the section content provided.

"""